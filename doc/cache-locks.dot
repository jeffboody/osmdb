// sudo apt-get install graphviz
// sudo apt-get install xdot
// xdot cache-locks.dot
digraph CACHE_LOCKS
{
	label="Cache Locks";
	fontsize=20;
	size="3,2";
	ratio=fill;

	lockRead       [shape=box, label="lockRead\nnon-exclusive"];
	lockLoad       [shape=box, label="lockLoad\n--readers\nif editor && readers==0\nthen signal\nnon-exclusive"];
	lockEdit       [shape=box, label="lockEdit\n--loaders\nexclusive"];
	lockReadUpdate [shape=box, label="lockReadUpdate\nexclusive"];
	lockLoadUpdate [shape=box, label="lockLoadUpdate\nexclusive"];
	lock           [shape=box, label="lock\nexclusive"];
	waitLoad       [shape=box, label="waitLoad\nwhile editor || loading"];
	waitRead       [shape=box, label="waitRead\nwhile editor"];
	waitEdit       [shape=box, label="waitEdit\nwhile readers || loaders"];
	unlock         [shape=box, label="unlock\noptionally signal"];
	unlockLoadErr  [shape=box, label="unlockLoadErr\n--loaders\nloading[tid]=-1\nsignal"];

	get            -> lockRead;
	lockRead       -> FIND [label="++readers"];
	lockRead       -> waitRead;
	waitRead       -> lockRead [style=dashed];
	FIND           -> lockReadUpdate [label="found"];
	FIND           -> lockLoad [label="not found"];
	LOAD           -> lockEdit [label="success"];
	LOAD           -> unlockLoadErr [label="failure"];
	lockLoad       -> RETRY_FIND [label="++loaders\nloading[tid]=type,id"];
	RETRY_FIND     -> lockLoadUpdate [label="found"];
	RETRY_FIND     -> LOAD [label="not found"];
	lockLoad       -> waitLoad;
	waitLoad       -> lockLoad [style=dashed];
	lockEdit       -> EDIT [label="editor=0\nloading[tid]=-1"];
	EDIT           -> unlock [label="signal=1"];
	lockEdit       -> waitEdit [label="editor=1"];
	waitEdit       -> lockEdit [style=dashed];
	put            -> lock;
	lockReadUpdate -> UPDATE_READ [label="--readers"];
	lockLoadUpdate -> UPDATE_LOAD [label="--loaders\nloading[tid]=-1"];
	UPDATE_READ    -> unlock [label="if editor && readers==0\nthen signal"];
	UPDATE_LOAD    -> unlock [label="signal=1"];
	lock           -> PUT;
	PUT            -> unlock [label="signal=0"];
}
